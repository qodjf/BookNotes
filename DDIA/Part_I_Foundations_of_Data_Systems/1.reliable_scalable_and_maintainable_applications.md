# 可靠、可扩展与可维护的应用系统
本章，我们探讨所关注的核心设计目标：可靠、可扩展与可维护的数据系统。正本清源。在后面的章节中，我们将层层推进，深入探讨系统设计时所面临的种种选择与权衡。

## 认识数据系统
本书关注于对大多数软件系统都极为重要的三个问题：
* 可靠性：即使发生了某些错误，系统仍可以正常工作，虽然性能可能降低
* 可扩展性：负载增加时，系统应以合理的方式应对这种增加。
* 可维护性：开发和运维上的可维护性

### 可靠性
错误或故障：可能出错的事情。

容错：系统可以应对错误。容错总是指容忍某些具体类型的错误，而不是所有错误。

故障不同于失效。故障是指组件偏离其预期，而失效意味着系统作为一个整体停止了。

故障的种类有：
| 故障类型 | 解决方法 |
| - | - |
| 硬件故障 | 通过软件容错的方式来解决，从而为替换故障硬件争取时间 |
| 软件错误 | 全面测试，进程隔离，监控 |
| 人为失误 | 以最小出错的方式来设计系统。充分测试。提供快速恢复机制。设置详细而清晰的监控子系统 |

### 可扩展性
可扩展性：系统应对负载增加的能力。
#### 描述负载
负载可以用称为负载参数的若干数字来描述。参数的最佳选择取决于系统的体系结构。例如每秒请求次数，数据库写请求的比例，活跃用户数量。有时候平均值很重要，有时少数峰值很重要。
#### 描述性能
在批处理系统中，通常更关心**吞吐量**。而在线系统中，通常更关心**响应时间**。

延迟不等于响应时间。延迟指系统处理请求的时间，而响应时间指客户端看到的时间，包括网络和排队等的时间。

最好不要将响应时间视为一个固定的数字，而是可度量的一种数值分布。想知道更典型的响应时间，平均值并不是合适的指标。百分位数更合适。其中中位数非常适合描述多少用户需要等待多长时间。而较高百分位数很重要，因为它们直接影响用户的总体服务体验。

百分位数通常用于描述和定义服务质量目标和服务质量协议。这些都是规定服务预期质量和可用性的合同。很重要的一点是要在客户端来测量响应时间。

实践中可以使用滑动窗口和一些近似算法来监控响应时间的百分位数。

#### 如何应对负载增加
采用水平扩展：将负载分布到多个小的机器。

超大规模的系统往往针对特定应用而高度定制，很难有一种通用的架构。背后取舍因素包括数据读取量、写入量、待存储的数据量、数据的复杂程度、响应时间要求、访问模式等，或者这些因素的叠加加上其它问题。

对于特定应用来说，扩展能力好的架构通常会做出某些假设，然后有针对性地优化设计。如果假设最终发现是错误的，那么可扩展性的努力就白费了。

可扩展性架构通常都是从通用模块逐步构建而来，背后往往有规律可循。

### 可维护性
众所周知，软件的大部分成本并不在最初的开发阶段，而是在于整个生命周期内持续的投入。

不幸的是，许多从业人员根本不喜欢维护这些所谓的遗留系统。但是换个角度，我们可以从*软件设计时*开始考虑，尽可能减少维护期间的麻烦，甚至避免造出容易过期的系统。为此，我们关注软件系统的三个设计原则：
* 可运维性
* 简单性：控制系统复杂性
* 可演化性：应对需求的变化
#### 可运维性
良好的可操作性意味着使日常工作变得简单。数据系统设计可以在这方面贡献很多，包括：
* 提供可观测性，方便监控
* 支持自动化，与标准工具集成
* 提供良好的默认配置，且允许方便地修改配置
* 尝试自我修复，必要时让管理员手动控制系统状态
#### 简单性：简化复杂度
降低复杂性可以大大提高系统的可维护性，因此简单性应该是我们构建系统的关键目标之一。

简化系统设计并不意味着减少系统功能，而主要意味着消除意外方面的复杂性。

我们将广泛考察如何设计好的抽象，这样至少能将大型系统的一部分抽象为定义明确、可重用的组件。
#### 可演化性
我们的目标是可以轻松地修改数据系统，使其适应不断变化的需求，这和简单性与抽象性密切相关：简单的系统往往更易于修改。这是一个非常重要的理念，我们用可演化性来指代数据系统级的敏捷性。